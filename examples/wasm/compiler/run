#!/bin/bash

# Ensure script is run from the project root
if [ ! -d "examples/wasm/compiler" ]; then
    echo "Error: This script must be run from the root of the FastLED project."
    echo "Please change to the project root directory and try again."
    exit 1
fi

# Function to build the Docker image
build_image() {
    if [ ! -f "examples/wasm/compiler/Dockerfile" ]; then
        echo "Error: Dockerfile not found in examples/wasm/compiler/"
        echo "Please make sure you are running this script from the root of the FastLED project."
        exit 1
    fi
    echo "Building Docker image..."
    docker build -t fastled-wasm-compiler -f examples/wasm/compiler/Dockerfile examples/wasm/compiler
}

# Function to display usage
usage() {
    echo "Usage: $0 [-b] <directory>"
    echo "  -b: Build the Docker image before running"
    echo "  <directory>: The directory to mount as a volume"
    exit 1
}

# Parse arguments
build_flag=false
while getopts ":b" opt; do
    case ${opt} in
        b )
            build_flag=true
            ;;
        \? )
            usage
            ;;
    esac
done
shift $((OPTIND -1))

# Check if directory argument is provided
if [ $# -eq 0 ]; then
    usage
fi

directory=$1

# Get absolute path of the directory
absolute_directory=$(realpath "$directory")

# Check if directory exists
if [ ! -d "$absolute_directory" ]; then
    echo "Error: Directory '$absolute_directory' does not exist."
    exit 1
fi

# Build image if -b flag is provided or if the image doesn't exist
if $build_flag || ! docker image inspect fastled-wasm-compiler >/dev/null 2>&1; then
    build_image
fi

# Run the container with the specified volume
# The local directory is mounted to /workspace inside the container
docker run --rm -it -v "$absolute_directory:/workspace" fastled-wasm-compiler
