<!-- this index.html is a minmal stub to show that the wasm build works.
     It will be packaged up with the js payload. Simply run it in the brower.
     If you are using this locally then you can do this easily by using `python -m http.server`
     or better yet, use npm's live-server and start live coding. -->


<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastLED Main Function</title>
    <script>
        const FRAME_RATE = 60; // 60 FPS

        
        // Function to call the setup and loop functions
        function runFastLED(extern_setup, extern_loop, frame_rate) {
            console.log("Calling setup function...");
            extern_setup();
            
            console.log("Starting loop...");
            const frameInterval = 1000 / frame_rate; // 60 FPS
            let lastFrameTime = 0;
            
            // Executes every frame but only runs the loop function at the specified frame rate
            function runLoop(currentTime) {
                if (currentTime - lastFrameTime >= frameInterval) {
                    extern_loop();
                    lastFrameTime = currentTime;
                }
                setTimeout(() => requestAnimationFrame(runLoop), 0);
            }
            requestAnimationFrame(runLoop);
  
        }

        // Ensure we wait for the module to load
        const onModuleLoaded = async () => {
            // Unpack the module functions and send them to the runFastLED function
            function __runFastLED(moduleInstance, frame_rate) {
                const exports_exist = moduleInstance && moduleInstance._extern_setup && moduleInstance._extern_loop;
                if (!exports_exist) {
                    console.error("FastLED setup or loop functions are not available.");
                    return;
                }
                return runFastLED(moduleInstance._extern_setup, moduleInstance._extern_loop, frame_rate);
            }
            try {
                if (typeof fastled === 'function') {
                    // Load the module
                    fastled().then(instance => {
                        console.log("Module loaded, running FastLED...");
                        __runFastLED(instance, FRAME_RATE);
                    }).catch(err => {
                        console.error("Error loading fastled as a module:", err);
                    });
                } else {
                    console.log("Could not detect a valid module loading for FastLED.");
                }
            } catch (error) {
                console.error("Failed to load FastLED:", error);
            }
        };

        // Bind the windows.onload event to the onModuleLoaded function.
        window.onload = onModuleLoaded;
    </script>
</head>

<body>
    <h1>Run FastLED Setup and Loop</h1>
    <pre id="output"></pre>

    <!-- Include the FastLED script -->
    <script src="fastled.js"></script>
</body>

</html>
