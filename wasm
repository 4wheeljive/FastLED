#!/bin/bash

# Push instructions (x86_64)
#   0. Only do this on x86_64.
#   1. docker login
#   2. ./wasm (builds the image and then runs a container)
#     a. This will create an image tagged by fastled-wasm-compiler
#   3. docker tag fastled-wasm-compiler:latest niteris/fastled-wasm:latest
#   4. docker push niteris/fastled-wasm:latest
#
# Pull instructions (arm)
#   0. Only do this on Mac-arm.
#   1. docker login
#   2. ./wasm (builds the image and then runs a container)
#     a. This will create an image tagged by fastled-wasm-compiler
#   3. docker tag fastled-wasm-compiler-arm64:latest niteris/fastled-wasm-arm64:latest
#   4. docker push niteris/fastled-wasm-arm64:latest

## Docker2exe
# Windows w/git bash
#   * ./docker2exe-windows-amd64.exe --name fastled --image niteris/fastled-wasm --module "github.com/niteris/fastled-wasm"
# https://github.com/rzane/docker2exe/releases/download/v0.2.1/docker2exe-windows-amd64

# AI:
setup_docker2exe() {
    if ! command -v wget &> /dev/null; then
        echo "Error: wget is not installed. Please install it using: winget install GnuWin32.Wget"
        exit 1
    fi

    if [ ! -d "ignore" ]; then
        mkdir -p ignore
    fi

    if [ ! -f "ignore/docker2exe.exe" ]; then
        wget -O ignore/docker2exe.exe https://github.com/rzane/docker2exe/releases/download/v0.2.1/docker2exe-windows-amd64
        chmod +x ignore/docker2exe.exe
    else
        echo "docker2exe.exe already exists, skipping download."
    fi
    ./ignore/docker2exe.exe --name fastled --image niteris/fastled-wasm --module "github.com/FastLED/FastLED"
    echo "Making wasm web cmd"
    mv ./ignore/fastled-darwin-amd64 ./dist/fastled-darwin-amd64
    mv ./ignore/fastled-darwin-arm64 ./dist/fastled-darwin-arm64
    mv ./ignore/fastled-linux-amd64 ./dist/fastled-linux-amd64
    mv ./ignore/fastled-windows-amd64.exe ./dist/fastled-windows-amd64.exe
    echo "Making wasm full cmd with no dependencies"
    ./ignore/docker2exe.exe --name fastled --image niteris/fastled-wasm --module "github.com/FastLED/FastLED" --embed
    mv ./ignore/fastled-darwin-amd64 ./dist/fastled-darwin-amd64-full
    mv ./ignore/fastled-darwin-arm64 ./dist/fastled-darwin-arm64-full
    mv ./ignore/fastled-linux-amd64 ./dist/fastled-linux-amd64-full
    mv ./ignore/fastled-windows-amd64.exe ./dist/fastled-windows-amd64-full.exe
    echo "Docker2exe done."
}

echo "Compiles sketch for wasm"

# Check if -b is in the arguments
if [[ " $@ " =~ " --build_wasm_compiler " ]]; then
    setup_docker2exe
    exit 0
fi

build_flag="-b"
uv run ci/wasm_compile.py $build_flag --open "$@"
